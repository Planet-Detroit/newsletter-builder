<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How Your Newsletter Builder Works — An Architecture Guide</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.7; }

  .hero { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 60px 24px; text-align: center; }
  .hero h1 { font-size: 2rem; margin-bottom: 8px; }
  .hero p { color: #94a3b8; font-size: 1.05rem; max-width: 600px; margin: 0 auto; }

  .container { max-width: 860px; margin: 0 auto; padding: 24px; }

  /* Concept cards */
  .concept { background: white; border-radius: 12px; border: 1px solid #e2e8f0; margin: 24px 0; overflow: hidden; }
  .concept-header { padding: 20px 24px; cursor: pointer; display: flex; align-items: center; gap: 14px; user-select: none; }
  .concept-header:hover { background: #f8fafc; }
  .concept-number { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; flex-shrink: 0; }
  .concept-title { flex: 1; }
  .concept-title h2 { font-size: 1.15rem; margin-bottom: 2px; }
  .concept-title .subtitle { font-size: 0.85rem; color: #64748b; }
  .concept-arrow { font-size: 1.2rem; color: #94a3b8; transition: transform 0.2s; }
  .concept.open .concept-arrow { transform: rotate(90deg); }
  .concept-body { display: none; padding: 0 24px 24px; }
  .concept.open .concept-body { display: block; }

  /* Color themes for each concept */
  .c1 .concept-number { background: #dbeafe; color: #1d4ed8; }
  .c2 .concept-number { background: #fce7f3; color: #be185d; }
  .c3 .concept-number { background: #d1fae5; color: #047857; }
  .c4 .concept-number { background: #fef3c7; color: #b45309; }
  .c5 .concept-number { background: #ede9fe; color: #6d28d9; }
  .c6 .concept-number { background: #ffe4e6; color: #be123c; }
  .c7 .concept-number { background: #ccfbf1; color: #0f766e; }
  .c8 .concept-number { background: #f3e8ff; color: #7c3aed; }

  /* Analogy box */
  .analogy { background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 16px; margin: 16px 0; }
  .analogy strong { color: #92400e; }
  .analogy::before { content: "Analogy: "; font-weight: 700; color: #b45309; }

  /* Your code box */
  .your-code { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin: 16px 0; }
  .your-code::before { content: "In your newsletter builder: "; font-weight: 700; color: #047857; display: block; margin-bottom: 6px; }

  /* File reference */
  .file { font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 0.82rem; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px 6px; color: #475569; white-space: nowrap; }

  /* Diagram */
  .diagram { background: #1e293b; border-radius: 8px; padding: 24px; margin: 20px 0; color: #e2e8f0; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 0.8rem; line-height: 1.8; overflow-x: auto; white-space: pre; }

  /* Key takeaway */
  .takeaway { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0; }
  .takeaway::before { content: "Key takeaway: "; font-weight: 700; color: #1d4ed8; }

  /* Sections within a concept */
  .concept-body h3 { font-size: 1rem; margin: 20px 0 8px; color: #334155; }
  .concept-body p { margin: 8px 0; color: #475569; }
  .concept-body ul { margin: 8px 0 8px 20px; color: #475569; }
  .concept-body li { margin: 4px 0; }

  /* Architecture overview diagram */
  .arch-overview { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 20px 0; }
  .arch-layer { border-radius: 8px; padding: 16px; position: relative; }
  .arch-layer h4 { font-size: 0.9rem; margin-bottom: 8px; }
  .arch-layer .items { display: flex; flex-wrap: wrap; gap: 6px; }
  .arch-layer .item { font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; background: rgba(255,255,255,0.3); }
  .layer-browser { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 1px solid #93c5fd; }
  .layer-server { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 1px solid #6ee7b7; }
  .layer-external { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fcd34d; }
  .layer-storage { background: linear-gradient(135deg, #ede9fe, #ddd6fe); border: 1px solid #c4b5fd; }
  .arrow-down { text-align: center; font-size: 1.4rem; color: #94a3b8; }

  /* Interactive quiz */
  .quiz { background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 8px; padding: 20px; margin: 20px 0; }
  .quiz h4 { color: #6d28d9; margin-bottom: 12px; }
  .quiz-btn { display: block; width: 100%; text-align: left; padding: 10px 14px; margin: 6px 0; border: 1px solid #e2e8f0; border-radius: 6px; background: white; cursor: pointer; font-size: 0.9rem; transition: all 0.15s; }
  .quiz-btn:hover { border-color: #a78bfa; background: #faf5ff; }
  .quiz-btn.correct { background: #d1fae5; border-color: #34d399; }
  .quiz-btn.wrong { background: #ffe4e6; border-color: #fca5a5; }
  .quiz-result { margin-top: 10px; font-size: 0.9rem; font-weight: 500; display: none; }

  /* Flow diagram */
  .flow { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 16px 0; }
  .flow-step { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 14px; font-size: 0.82rem; font-weight: 500; text-align: center; }
  .flow-arrow { color: #94a3b8; font-size: 1.2rem; }
  .flow-step.highlight { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }

  footer { text-align: center; padding: 40px 24px; color: #94a3b8; font-size: 0.85rem; }
</style>
</head>
<body>

<div class="hero">
  <h1>How Your Newsletter Builder Works</h1>
  <p>A plain-language guide to the architecture of the tool you helped build — and the web development concepts behind it.</p>
</div>

<div class="container">

<!-- Big Picture -->
<div style="margin: 32px 0;">
  <h2 style="font-size: 1.3rem; margin-bottom: 16px;">The Big Picture</h2>
  <p style="color: #475569; margin-bottom: 16px;">Your newsletter builder has four layers. Everything in web development fits into one of these. Think of it like a restaurant: the dining room (browser), the kitchen (server), the suppliers (external services), and the pantry (storage).</p>

  <div class="arch-overview">
    <div class="arch-layer layer-browser">
      <h4>Browser (what you see and interact with)</h4>
      <div class="items">
        <span class="item">Header.tsx</span>
        <span class="item">IntroEditor.tsx</span>
        <span class="item">AdManager.tsx</span>
        <span class="item">CO2Widget.tsx</span>
        <span class="item">JobsSelector.tsx</span>
        <span class="item">+ 15 more components</span>
      </div>
    </div>
    <div class="arrow-down">&#8595;</div>
    <div class="arch-layer layer-server">
      <h4>Your Server (the kitchen — processes requests, talks to outside services)</h4>
      <div class="items">
        <span class="item">/api/draft</span>
        <span class="item">/api/activecampaign</span>
        <span class="item">/api/wordpress/posts</span>
        <span class="item">/api/co2</span>
        <span class="item">/api/auth/login</span>
        <span class="item">+ 16 more routes</span>
      </div>
    </div>
    <div class="arrow-down">&#8595;</div>
    <div class="arch-layer layer-external">
      <h4>External Services (the suppliers — other companies' systems)</h4>
      <div class="items">
        <span class="item">ActiveCampaign</span>
        <span class="item">WordPress</span>
        <span class="item">NOAA / Scripps</span>
        <span class="item">AirNow.gov</span>
        <span class="item">Claude AI</span>
      </div>
    </div>
    <div class="arrow-down">&#8595;</div>
    <div class="arch-layer layer-storage">
      <h4>Storage (the pantry — where data lives)</h4>
      <div class="items">
        <span class="item">Redis (shared drafts, previews, snapshots)</span>
        <span class="item">localStorage (offline backup)</span>
      </div>
    </div>
  </div>
</div>

<!-- Concept 1: Components -->
<div class="concept c1" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">1</div>
    <div class="concept-title">
      <h2>Components — The Building Blocks</h2>
      <div class="subtitle">What are React components and why does everything end in .tsx?</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">A component is like a LEGO brick. Each brick has a specific shape and purpose — a door brick, a window brick, a roof brick. You snap them together to build a house. In your app, each <span class="file">.tsx</span> file in <span class="file">src/components/</span> is one brick.</div>

    <p>A component is a reusable piece of your interface. It defines what something looks like <em>and</em> how it behaves. The <span class="file">.tsx</span> extension means "TypeScript with HTML-like syntax" — you write what looks like HTML, but with JavaScript logic mixed in.</p>

    <div class="your-code">
      Your app has <strong>20 components</strong> organized into two groups:
      <ul>
        <li><strong>Dashboard/</strong> — the frame of the app: <span class="file">Header.tsx</span> (top bar with sync status), <span class="file">IssueManager.tsx</span> (the date/issue controls), <span class="file">ProgressBar.tsx</span>, <span class="file">SectionCard.tsx</span></li>
        <li><strong>Sections/</strong> — the content editors: <span class="file">IntroEditor.tsx</span> (where you write the editor's letter), <span class="file">AdManager.tsx</span> (the ad builder — your largest component at 839 lines), <span class="file">CO2Widget.tsx</span>, <span class="file">CuratedNewsImport.tsx</span>, etc.</li>
      </ul>
    </div>

    <h3>How components nest together</h3>
    <div class="diagram">page.tsx (the home page)
  ├── Header.tsx (top bar)
  ├── ProgressBar.tsx
  ├── IssueManager.tsx
  └── SectionCard.tsx (one per section)
        └── SectionEditor.tsx
              └── IntroEditor.tsx     ← or any section editor
              └── AdManager.tsx
              └── CO2Widget.tsx
              └── ... etc</div>

    <div class="takeaway">Components are self-contained UI pieces. Nest small ones inside bigger ones to build your full interface. Each component manages its own behavior but can share data through "context" (covered in concept 4).</div>
  </div>
</div>

<!-- Concept 2: Client vs Server -->
<div class="concept c2" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">2</div>
    <div class="concept-title">
      <h2>Client vs. Server — The Two Worlds</h2>
      <div class="subtitle">Why some code runs in the browser and some on Vercel</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">Think of a bank. The <strong>lobby</strong> (client/browser) is where you fill out forms, see your balance, and press buttons. But the <strong>vault</strong> (server) is where the real money is — you never go there directly. When you submit a withdrawal slip, a teller carries it to the vault and brings back cash. API routes are your tellers.</div>

    <p>Your app has two entirely separate execution environments:</p>

    <ul>
      <li><strong>Client (browser)</strong> — all files with <span class="file">"use client"</span> at the top. These run on the user's computer in Chrome/Safari/etc. They can show UI, respond to clicks, and store data in <span class="file">localStorage</span>. But they <em>cannot</em> access secrets like API keys.</li>
      <li><strong>Server (Vercel)</strong> — all files in <span class="file">src/app/api/</span>. These run on Vercel's computers. They <em>can</em> access API keys, talk to databases, and call external services. But they <em>cannot</em> show any UI.</li>
    </ul>

    <h3>Why this split matters</h3>
    <p>Your ActiveCampaign API key is a secret. If it were in browser code, anyone could view-source and steal it. So instead:</p>

    <div class="flow">
      <div class="flow-step">You click "Generate Newsletter"</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">Browser sends request to /api/activecampaign</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">Server reads API key from env vars</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">Server calls ActiveCampaign</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">Server sends result back to browser</div>
    </div>

    <div class="your-code">
      <strong>Client files</strong> (20 components): everything in <span class="file">src/components/</span> and <span class="file">src/context/</span><br>
      <strong>Server files</strong> (21 API routes): everything in <span class="file">src/app/api/</span><br>
      <strong>Secrets kept safe</strong>: ACTIVECAMPAIGN_API_KEY, AUTH_SECRET, WORDPRESS_APP_PASSWORD, UPSTASH_REDIS_REST_TOKEN
    </div>

    <div class="takeaway">Client code makes the UI work. Server code keeps secrets safe and talks to external services. They communicate through API requests — the browser asks, the server answers.</div>
  </div>
</div>

<!-- Concept 3: API Routes -->
<div class="concept c3" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">3</div>
    <div class="concept-title">
      <h2>API Routes — The Messengers</h2>
      <div class="subtitle">What happens when the browser talks to the server</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">An API route is like a specific window at a post office. Each window handles one type of request. Window 1 does stamps, Window 2 does packages, Window 3 does registered mail. You go to the right window, hand over your request, and get back a response.</div>

    <p>In Next.js, every file named <span class="file">route.ts</span> inside <span class="file">src/app/api/</span> becomes a URL the browser can call. The folder structure <em>is</em> the URL:</p>

    <div class="diagram">src/app/api/co2/route.ts          → GET  /api/co2
src/app/api/draft/route.ts        → GET or POST /api/draft
src/app/api/auth/login/route.ts   → POST /api/auth/login
src/app/api/wordpress/posts/route.ts → GET /api/wordpress/posts</div>

    <h3>GET vs. POST</h3>
    <p><strong>GET</strong> means "give me data" — like reading. <strong>POST</strong> means "here's some data, do something with it" — like submitting a form. Most of your routes use one or both.</p>

    <div class="your-code">
      Your 21 API routes fall into categories:
      <ul>
        <li><strong>Data fetchers</strong> — <span class="file">/api/co2</span>, <span class="file">/api/air-quality</span>, <span class="file">/api/lake-levels</span> call external APIs and return cleaned-up data</li>
        <li><strong>WordPress bridge</strong> — <span class="file">/api/wordpress/posts</span>, <span class="file">/api/wordpress/jobs</span>, <span class="file">/api/wordpress/media</span> talk to your WP site</li>
        <li><strong>AI processors</strong> — <span class="file">/api/intro</span>, <span class="file">/api/curated-news</span>, <span class="file">/api/parse-events</span> use Claude to process text</li>
        <li><strong>State management</strong> — <span class="file">/api/draft</span> (shared drafts), <span class="file">/api/share-preview</span> (shareable links)</li>
        <li><strong>Auth</strong> — <span class="file">/api/auth/login</span>, <span class="file">/api/auth/logout</span></li>
        <li><strong>Email platform</strong> — <span class="file">/api/activecampaign/*</span> (campaigns, stats, snapshots)</li>
      </ul>
    </div>

    <div class="quiz" onclick="event.stopPropagation()">
      <h4>Quick check</h4>
      <p>When you click "Fetch CO2 Data" in the CO2 widget, what happens?</p>
      <button class="quiz-btn" onclick="checkAnswer(this, false)">The browser reads CO2 data directly from NOAA's website</button>
      <button class="quiz-btn" onclick="checkAnswer(this, true)">The browser asks /api/co2, which calls NOAA's API on the server, then sends cleaned data back</button>
      <button class="quiz-btn" onclick="checkAnswer(this, false)">The CO2 data is stored in the component and doesn't need an API call</button>
      <div class="quiz-result"></div>
    </div>

    <div class="takeaway">API routes are the bridge between what users see (browser) and what the app needs to do behind the scenes (call external services, access secrets, store data). The folder name becomes the URL.</div>
  </div>
</div>

<!-- Concept 4: State Management -->
<div class="concept c4" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">4</div>
    <div class="concept-title">
      <h2>State — The App's Memory</h2>
      <div class="subtitle">How all 20 components share the same newsletter data</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">Imagine 10 people building a jigsaw puzzle. If each person has their own copy of the puzzle, chaos. Instead, there's <strong>one shared table</strong> (the state) in the middle. When someone places a piece, everyone sees it. That shared table is your <span class="file">NewsletterContext.tsx</span>.</div>

    <p>"State" is just the current data your app is working with — the subject line, the intro text, which stories are selected, which ads are active, etc. The challenge is: 20 different components all need to read and modify this data.</p>

    <h3>The pattern: Context + Reducer</h3>
    <p>Your app uses React's "Context" pattern. There's one master object (<span class="file">NewsletterState</span>) with 22 fields, and a single function (the "reducer") that knows how to update each one:</p>

    <div class="diagram">NewsletterState = {
  subjectLine: "This week in Detroit..."   ← Header section edits this
  intro: "Hello Planet Detroiters..."      ← IntroEditor edits this
  pdPosts: [{...}, {...}]                  ← PDStoriesSelector edits this
  curatedStories: [{...}, {...}]           ← CuratedNewsImport edits this
  ads: [{...}]                             ← AdManager edits this
  co2: { current: 427.5, ... }            ← CO2Widget edits this
  ... 16 more fields
}</div>

    <h3>How updates work</h3>
    <p>Components don't modify state directly. Instead, they send a message (called a "dispatch") describing what changed:</p>

    <div class="flow">
      <div class="flow-step">You type in the subject line</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">dispatch({ type: "SET_SUBJECT_LINE", payload: "..." })</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">Reducer updates state</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">All components re-render with new data</div>
    </div>

    <div class="your-code">
      <span class="file">src/context/NewsletterContext.tsx</span> (485 lines) is the heart of your app. It:
      <ul>
        <li>Holds the <strong>one source of truth</strong> for all newsletter data</li>
        <li>Has <strong>28 action types</strong> (SET_SUBJECT_LINE, SET_INTRO, SET_ADS, etc.)</li>
        <li>Auto-saves to <strong>localStorage</strong> every 1 second</li>
        <li>Auto-saves to <strong>Redis</strong> for shared editing</li>
        <li>Polls every 5 seconds for changes from other editors</li>
        <li>Does <strong>section-level merge</strong> so your intro edits don't overwrite Dustin's curated stories edits</li>
      </ul>
    </div>

    <div class="takeaway">State is your app's memory. Context shares it across all components. The reducer is the gatekeeper — it ensures every change follows a predictable pattern. This is why you can edit the intro while Dustin edits jobs, and nothing gets lost.</div>
  </div>
</div>

<!-- Concept 5: Types -->
<div class="concept c5" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">5</div>
    <div class="concept-title">
      <h2>Types — The Contracts</h2>
      <div class="subtitle">Why TypeScript catches mistakes before they happen</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">Types are like a form with labeled boxes. A "Phone Number" box won't accept "hello" — it expects digits. TypeScript does the same thing for your code. If a function expects a <em>number</em> and you pass it <em>text</em>, it flags the error before anything runs.</div>

    <p>In plain JavaScript, you could accidentally write <code>post.ttle</code> instead of <code>post.title</code> and not know until the app crashes. TypeScript catches that <em>instantly</em> in your editor.</p>

    <div class="your-code">
      <span class="file">src/types/newsletter.ts</span> (256 lines) defines the shape of everything in your app:
      <ul>
        <li><strong>PDPost</strong> — what a WordPress post looks like (id, title, subtitle, excerpt, url, featuredImage, date, selected, photoLayout)</li>
        <li><strong>CuratedStory</strong> — a curated news item (id, headline, source, url, summary, selected)</li>
        <li><strong>AdSlot</strong> — an ad placement (id, name, htmlContent, position, active)</li>
        <li><strong>NewsletterState</strong> — the entire state object (22 fields, all typed)</li>
        <li><strong>STAFF_MEMBERS</strong> — the team list used for sign-off (Nina, Dustin, Ethan, Brian, Isabelle, Ian)</li>
      </ul>
    </div>

    <p>When we ran <span class="file">npx tsc --noEmit</span> after every change, that was TypeScript checking that every piece of data matches its defined shape — across all 54 files at once.</p>

    <div class="takeaway">Types are guardrails. They document what data looks like and prevent you from passing the wrong thing. That's why we run the TypeScript checker after every change — if it passes, we know the pieces still fit together.</div>
  </div>
</div>

<!-- Concept 6: Middleware & Auth -->
<div class="concept c6" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">6</div>
    <div class="concept-title">
      <h2>Middleware & Auth — The Bouncer</h2>
      <div class="subtitle">How the login system protects the app</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">Middleware is the bouncer at the door. <em>Every</em> request to your app passes through it first. The bouncer checks your wristband (cookie) — if it's valid, you're in. If not, you're redirected to the door (login page). Some areas are VIP-free (public preview links).</div>

    <p>Your <span class="file">src/middleware.ts</span> (46 lines) runs before every page load and API call. Here's what it decides:</p>

    <div class="diagram">Request comes in
  │
  ├── Is it /login or /api/auth/login?
  │     └── YES → Let through (can't lock people out of login)
  │
  ├── Is it /newsletter-preview or /ad-preview?
  │     └── YES → Let through (clients need to see these)
  │
  ├── Is it GET /api/share-preview?
  │     └── YES → Let through (shared links are public)
  │
  └── Does the request have a valid pd_auth cookie?
        ├── YES → Let through
        └── NO  → Redirect to /login (or 401 for API calls)</div>

    <div class="your-code">
      The auth flow uses three pieces:
      <ul>
        <li><span class="file">src/app/login/page.tsx</span> — the login form (now with "Who's working today?" name selector)</li>
        <li><span class="file">src/app/api/auth/login/route.ts</span> — checks the password, creates a signed token, sets cookies (<span class="file">pd_auth</span> + <span class="file">pd_user</span>)</li>
        <li><span class="file">src/lib/auth.ts</span> — the crypto functions that sign and verify the token using HMAC-SHA256</li>
      </ul>
    </div>

    <div class="quiz" onclick="event.stopPropagation()">
      <h4>Quick check</h4>
      <p>Why can clients see newsletter previews without logging in?</p>
      <button class="quiz-btn" onclick="checkAnswer(this, false)">Preview pages don't use any API routes</button>
      <button class="quiz-btn" onclick="checkAnswer(this, true)">The middleware has an exception list that lets /newsletter-preview through without a cookie check</button>
      <button class="quiz-btn" onclick="checkAnswer(this, false)">Preview links include the password in the URL</button>
      <div class="quiz-result"></div>
    </div>

    <div class="takeaway">Middleware is a checkpoint that runs on every request. It keeps the app secure while allowing specific public routes. The auth system uses signed cookies — cryptographic proof that you logged in, without storing anything on the server.</div>
  </div>
</div>

<!-- Concept 7: Storage & Sync -->
<div class="concept c7" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">7</div>
    <div class="concept-title">
      <h2>Storage & Sync — The Memory System</h2>
      <div class="subtitle">How your data persists and how collaborative editing works</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">Think of two levels of memory: <strong>a sticky note on your monitor</strong> (localStorage — fast, but only you can see it) and <strong>a shared Google Doc</strong> (Redis — everyone sees the same thing, but requires internet). Your app uses both.</div>

    <h3>localStorage (browser-side)</h3>
    <p>Every 1 second, your entire newsletter state is saved to your browser's localStorage under the key <span class="file">"pd-newsletter-draft"</span>. This is your safety net — if you lose internet, your work is still there. But it's <em>per-browser</em>: Nina's Chrome and Dustin's Chrome have separate copies.</p>

    <h3>Redis (server-side)</h3>
    <p>Redis is a fast cloud database (hosted by Upstash). It stores your shared draft, preview links, and ad snapshots. Unlike localStorage, it's shared — both editors see the same data.</p>

    <div class="diagram">Redis keys your app uses:
  nl:draft:state    → The full shared newsletter state (JSON)
  nl:draft:version  → Version counter (number, goes up with every save)
  nl:draft:editor   → { userId: "Nina", updatedAt: "2026-02-09T..." }
  nl:preview:{id}   → Shared preview HTML (7-day TTL)
  nl:ad-snap:{id}   → Ad performance snapshot (90-day TTL)</div>

    <h3>The collaborative sync loop</h3>
    <div class="flow">
      <div class="flow-step">Nina edits intro</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">Auto-save to Redis (1s debounce)</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">Dustin's browser polls every 5s</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">Detects new version from Nina</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">3-way merge: keeps Dustin's edits, takes Nina's changes</div>
    </div>

    <div class="your-code">
      The merge logic in <span class="file">src/lib/sync.ts</span> groups your 22 state fields into 10 "section groups" (header, intro, stories, curated, events, jobs, psCta, ads, sponsors, env). When merging:
      <ul>
        <li>If you <em>didn't</em> change a section group → accept the other person's version</li>
        <li>If you <em>did</em> change it → keep yours</li>
      </ul>
      This means Nina can edit the intro while Dustin edits jobs, and both changes merge cleanly.
    </div>

    <div class="takeaway">localStorage is your personal backup. Redis is the shared truth. The sync system uses a "3-way merge" — comparing your version, their version, and the last shared version — to combine edits without data loss.</div>
  </div>
</div>

<!-- Concept 8: The HTML Pipeline -->
<div class="concept c8" onclick="this.classList.toggle('open')">
  <div class="concept-header">
    <div class="concept-number">8</div>
    <div class="concept-title">
      <h2>The HTML Pipeline — From Editor to Inbox</h2>
      <div class="subtitle">How your newsletter becomes an actual email</div>
    </div>
    <span class="concept-arrow">&#9654;</span>
  </div>
  <div class="concept-body">
    <div class="analogy">You're building the newsletter like a Word doc, but email clients (Gmail, Outlook, Apple Mail) are stuck in the 1990s. They can't handle modern web code. So <span class="file">generateNewsletterHTML.ts</span> is like a translator that converts your modern content into old-school HTML that every email client understands.</div>

    <p>When you click "Generate Newsletter," here's the full journey:</p>

    <div class="flow">
      <div class="flow-step">Click "Generate Newsletter"</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">generateNewsletterHTML(state)</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step highlight">376 lines of email-safe HTML</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">POST /api/activecampaign</div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step">ActiveCampaign creates draft campaign</div>
    </div>

    <div class="your-code">
      <span class="file">src/lib/generateNewsletterHTML.ts</span> (376 lines) is the template engine. It takes your entire NewsletterState and produces a single HTML string with:
      <ul>
        <li><strong>Table-based layout</strong> — emails use <code>&lt;table&gt;</code> instead of modern CSS (Outlook requires it)</li>
        <li><strong>Inline styles</strong> — no external CSS files work in email</li>
        <li><strong>MSO conditional comments</strong> — special code that only Microsoft Outlook reads (for button rendering)</li>
        <li><strong>Hidden preheader text</strong> — the preview snippet you see in your inbox</li>
        <li><strong>Ad slots</strong> — inserted between sections based on position (after-intro, after-pd-stories, etc.)</li>
      </ul>
    </div>

    <div class="takeaway">The HTML generator is the final translation layer. It takes your nicely-structured state data and converts it into the ugly-but-necessary HTML that email clients from 2005 can render correctly. That's why email development is its own specialty.</div>
  </div>
</div>

<!-- File Map -->
<div style="margin: 40px 0;">
  <h2 style="font-size: 1.3rem; margin-bottom: 16px;">Quick Reference: What Each File Does</h2>
  <div style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
      <thead>
        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
          <th style="padding: 12px 16px; text-align: left;">File</th>
          <th style="padding: 12px 16px; text-align: left;">Purpose</th>
          <th style="padding: 12px 16px; text-align: left;">Layer</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">NewsletterContext.tsx</td><td style="padding: 10px 16px;">The brain — holds all state, auto-saves, syncs with Redis</td><td style="padding: 10px 16px;"><span style="color:#1d4ed8">Client</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">newsletter.ts (types)</td><td style="padding: 10px 16px;">Defines the shape of every data object</td><td style="padding: 10px 16px;"><span style="color:#6d28d9">Shared</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">generateNewsletterHTML.ts</td><td style="padding: 10px 16px;">Converts state → email-safe HTML</td><td style="padding: 10px 16px;"><span style="color:#1d4ed8">Client</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">sync.ts</td><td style="padding: 10px 16px;">Section-level merge for collaborative editing</td><td style="padding: 10px 16px;"><span style="color:#1d4ed8">Client</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">middleware.ts</td><td style="padding: 10px 16px;">The bouncer — checks auth on every request</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">redis.ts</td><td style="padding: 10px 16px;">Connects to Upstash Redis (shared database)</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">auth.ts</td><td style="padding: 10px 16px;">Signs & verifies login tokens</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">api/draft/route.ts</td><td style="padding: 10px 16px;">Save/load shared draft from Redis</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
        <tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">api/activecampaign/*</td><td style="padding: 10px 16px;">Create campaigns, track performance, save snapshots</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
        <tr><td style="padding: 10px 16px; font-family: monospace; font-size: 0.78rem;">api/wordpress/*</td><td style="padding: 10px 16px;">Fetch posts, jobs, upload images</td><td style="padding: 10px 16px;"><span style="color:#047857">Server</span></td></tr>
      </tbody>
    </table>
  </div>
</div>

<div style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 24px; margin: 24px 0;">
  <h3 style="margin-bottom: 12px;">Your System by the Numbers</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #1d4ed8;">8,680</div>
      <div style="font-size: 0.8rem; color: #64748b;">lines of code</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #be185d;">54</div>
      <div style="font-size: 0.8rem; color: #64748b;">source files</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #047857;">21</div>
      <div style="font-size: 0.8rem; color: #64748b;">API routes</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #b45309;">20</div>
      <div style="font-size: 0.8rem; color: #64748b;">UI components</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #6d28d9;">5</div>
      <div style="font-size: 0.8rem; color: #64748b;">external services</div>
    </div>
  </div>
</div>

</div>

<footer>
  Built for Planet Detroit by Nina + Claude &middot; February 2026
</footer>

<script>
function checkAnswer(btn, correct) {
  const quiz = btn.closest('.quiz');
  const buttons = quiz.querySelectorAll('.quiz-btn');
  const result = quiz.querySelector('.quiz-result');
  buttons.forEach(b => {
    b.disabled = true;
    b.style.cursor = 'default';
  });
  if (correct) {
    btn.classList.add('correct');
    result.textContent = 'Correct!';
    result.style.color = '#047857';
  } else {
    btn.classList.add('wrong');
    buttons.forEach(b => { if (!b.classList.contains('wrong')) { /* find correct */ } });
    result.textContent = 'Not quite — the server acts as the middleman to keep API keys safe and clean up the data before sending it to your browser.';
    result.style.color = '#be123c';
  }
  result.style.display = 'block';
}
</script>
</body>
</html>
